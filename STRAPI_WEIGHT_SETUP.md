# إعداد نظام الأوزان المتعددة في Strapi

## نظرة عامة
تم تطوير نظام جديد يدعم اختيار **أوزان متعددة** في نفس الوقت للمنتجات المباعة بالوزن (مثل التوابل، العطارة، القهوة).

## الميزات الجديدة

### 1. الاختيار المتعدد للأوزان
- يمكن للمستخدم اختيار **أكثر من وزن** في نفس الوقت
- مثال: 1 كج + 0.5 كج + 0.25 كج = 1.75 كج إجمالي

### 2. حساب السعر الذكي
- يحسب السعر الإجمالي بناءً على مجموع جميع الأوزان المختارة
- يعرض تفصيل السعر لكل وزن منفرد
- يحسب متوسط السعر لكل وحدة وزن

### 3. واجهة مستخدم محسنة
- أزرار اختيار متعددة مع إمكانية إلغاء الاختيار
- عرض ملخص للأوزان المختارة
- رسائل تحذير إذا لم يتم اختيار أي وزن

## خطوات الإعداد في Strapi

### 1. إعداد Collection Types

#### A. إنشاء Unit Collection
1. اذهب إلى **Content-Type Builder** → **Create new collection type**
2. اسم الـ Collection: `Unit`
3. أضف الحقول التالية:
   ```
   - name (Text): اسم الوحدة (مثل: كيلوجرام)
   - shortName (Text): الاختصار (مثل: كج، جم، رطل)
   - symbol (Text): الرمز (مثل: kg, g, lb)
   ```

#### B. إنشاء Quantity Option Collection  
1. اذهب إلى **Content-Type Builder** → **Create new collection type**
2. اسم الـ Collection: `Quantity Option`
3. أضف الحقول التالية:
   ```
   - value (Number): قيمة الوزن (مثل: 0.25, 0.5, 1)
   - price_modifier (Number): معدل السعر (مثل: 1.0, 1.1, 1.2)
   - displayName (Text): الاسم المعروض (مثل: ربع كيلو، نصف كيلو)
   - unit (Relation): علاقة مع Unit Collection (One-to-One)
   ```

#### C. تحديث Product Collection
أضف الحقول التالية لـ Product Collection الموجود:
```
- isWeighed (Boolean): هل المنتج مباع بالوزن؟
- unit (Relation): علاقة مع Unit Collection (Many-to-One)  
- quantity_options (Relation): علاقة مع Quantity Option (One-to-Many)
```

### 2. إنشاء البيانات الأساسية

#### A. إنشاء Units
1. **الكيلوجرام**:
   - name: `كيلوجرام`
   - shortName: `كج`
   - symbol: `kg`

2. **الجرام**:
   - name: `جرام`  
   - shortName: `جم`
   - symbol: `g`

#### B. إنشاء Quantity Options
1. **ربع كيلو**:
   - value: `0.25`
   - price_modifier: `1.2` (زيادة 20%)
   - displayName: `ربع كيلو`
   - unit: اختر `كيلوجرام`

2. **نصف كيلو**:
   - value: `0.5`
   - price_modifier: `1.1` (زيادة 10%)
   - displayName: `نصف كيلو`
   - unit: اختر `كيلوجرام`

3. **كيلو واحد**:
   - value: `1`
   - price_modifier: `1.0` (بدون تغيير)
   - displayName: `كيلو واحد`
   - unit: اختر `كيلوجرام`

### 3. إعداد منتج مباع بالوزن

#### خطوات إعداد منتج "بن بالشعفر":
1. اذهب إلى **Content Manager** → **Product** → **بن بالشعفر**
2. قم بتحديث الحقول التالية:
   - ✅ `isWeighed`: فعل هذا الحقل (true)
   - ✅ `unit`: اختر `كيلوجرام`
   - ✅ `quantity_options`: اختر الخيارات التالية:
     - ربع كيلو
     - نصف كيلو  
     - كيلو واحد
3. احفظ التغييرات

### 4. إعدادات الصلاحيات
تأكد من أن **Public Role** لديه صلاحيات:
- ✅ Product: find, findOne
- ✅ Unit: find, findOne  
- ✅ Quantity Option: find, findOne

## مثال على البيانات المتوقعة

```json
{
  "id": 1,
  "title": "بن بالشعفر",
  "price": 200.00,
  "isWeighed": true,
  "unit": {
    "data": {
      "attributes": {
        "name": "كيلوجرام",
        "shortName": "كج",
        "symbol": "kg"
      }
    }
  },
  "quantity_options": [
    {
      "id": 1,
      "value": 0.25,
      "price_modifier": 1.2,
      "displayName": "ربع كيلو",
      "unit": {
        "data": {
          "attributes": {
            "shortName": "كج"
          }
        }
      }
    },
    {
      "id": 2,
      "value": 0.5,
      "price_modifier": 1.1,
      "displayName": "نصف كيلو",
      "unit": {
        "data": {
          "attributes": {
            "shortName": "كج"
          }
        }
      }
    },
    {
      "id": 3,
      "value": 1,
      "price_modifier": 1.0,
      "displayName": "كيلو واحد",
      "unit": {
        "data": {
          "attributes": {
            "shortName": "كج"
          }
        }
      }
    }
  ]
}
```

## حساب الأسعار

### مثال: بن بالشعفر
- **السعر الأساسي**: 200 ريال/كج
- **ربع كيلو**: 200 × 0.25 × 1.2 = 60 ريال
- **نصف كيلو**: 200 × 0.5 × 1.1 = 110 ريال  
- **كيلو واحد**: 200 × 1 × 1.0 = 200 ريال
- **المجموع**: 60 + 110 + 200 = 370 ريال
- **إجمالي الوزن**: 0.25 + 0.5 + 1 = 1.75 كج

## الميزات الجديدة في الواجهة

### 1. اختيار متعدد للأوزان
- أزرار يمكن النقر عليها لاختيار/إلغاء اختيار كل وزن
- عرض بصري للأوزان المختارة
- إمكانية إزالة وزن محدد من الاختيار

### 2. عرض السعر المحسن
- السعر الإجمالي لجميع الأوزان المختارة
- إجمالي الوزن
- متوسط السعر لكل وحدة وزن
- تفصيل السعر لكل وزن منفرد

### 3. تحسينات في السلة
- عرض تفاصيل الأوزان المتعددة
- حساب السعر الإجمالي
- رسائل واتساب محسنة مع تفاصيل الأوزان

## استكشاف الأخطاء

### المشكلة: خيارات الوزن لا تظهر
✅ **الحلول**:
1. تأكد من `isWeighed = true` في المنتج
2. تأكد من وجود `quantity_options` مربوطة بالمنتج
3. تأكد من `populate: '*'` في API call
4. تحقق من صلاحيات Public Role

### المشكلة: السعر لا يحسب بشكل صحيح  
✅ **الحلول**:
1. تحقق من `price_modifier` في Quantity Options
2. تأكد من `value` صحيح (0.25, 0.5, 1.0)
3. تحقق من السعر الأساسي في المنتج

### المشكلة: لا يمكن اختيار أكثر من وزن
✅ **الحلول**:
1. تأكد من تحديث الكود ليدعم `selectedWeightOptions` array
2. تحقق من `onOptionToggle` function
3. تأكد من أن `WeightOptions` component يستقبل `selectedOptions` array

---

**ملاحظة**: تم إضافة نظام mock data مؤقت للمنتجات التي تحتوي على "بن"، "قهوة"، "توابل"، أو "عطارة" في الاسم لأغراض الاختبار. بعد إعداد Strapi بشكل صحيح، يمكن إزالة هذا النظام المؤقت.
